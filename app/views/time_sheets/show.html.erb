<h1>Timesheet</h1>

<% if notice %>
<div id="notice" class="alert alert-success">
  <%= notice %>
</div>
<% end %>

<%
  week = (Time.zone.today.at_beginning_of_week...Time.zone.today.next_week)
  year = week.min.year
%>

<%= link_to 'New Single Entry', new_time_sheet_single_entry_path(@sheet), class: 'btn btn-primary btn-small' %>

<br/>
<br/>
<div class="hero-unit">
  <h3><%= @sheet.user.name %></h3>
  <table class="table">
    <thead>
      <tr>
        <th colspan="2">Week Summary</th>
        <th colspan="2">Vacation <%=year%></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Work</td>
        <td><%= format_duration(@sheet.total_duration_for(week, :work), :work) %></td>

        <td>Redeemed</td>
        <td><%= format_duration(@sheet.total_vacation_for(year), :vacation, :work_days) %></td>
      </tr>
      <tr>
        <td>Overtime</td>
        <td><%= format_duration(@sheet.total_overtime_for(week), :overtime) %></td>

        <td>Remaining</td>
        <td><%= format_duration(@sheet.total_remaining_vacation_for(year), :vacation, :work_days) %></td>
      </tr>
      <% 
        onduty = @sheet.total_duration_for(week, :onduty)
        if onduty != 0 
      %>
      <tr>
        <td>On duty</td>
        <td><%= format_duration(onduty, :onduty) %></td>

        <td>&nbsp;</td>
        <td>&nbsp;</td>
      </tr>
      <%
        end
      %>
    </tbody>
  </table>
</div>
<br/>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Start</th>
      <th>End</th>
      <th>Duration</th>
      <th>Type</th>
      <th>&nbsp;</th>
    </tr>
  </thead>
<%
  week.to_a.each do |date|
%>
  <tr <%=raw ::UberZeit::is_work_day?(date) ? '' : 'style="background-color: #CCC"' %>>
    <th colspan="5"><%=date.strftime('%A, %d.%m.%Y')%></th>
  </tr>
  <tbody>
    <% @sheet.chunks_for(date).each do |entry| %>
    <tr>
      <% 
        if entry.parent.whole_day?
      %> 
        <td colspan="2"><em>Whole day</em></td>
      <%
        else
      %>
        <td><%= entry.starts.strftime("%R")  %></td>
        <td><%= entry.ends.strftime("%R") %></td>
      <%
        end
      %>
      <td><%= format_duration(entry.duration, entry.time_type) %></td>
      <td><%= entry.time_type %></td>
      <% if entry.parent.kind_of?(SingleEntry) %>
      <td>
        <%= link_to 'Edit', edit_time_sheet_single_entry_path(@sheet, entry.parent), :class => 'btn btn-small' %>
        <%= link_to 'Destroy', [@sheet, entry.parent], :class => 'btn btn-danger btn-small', :method => :delete, :data => { :confirm => 'Are you sure?' } %>
      </td>
      <% end %>
    </tr>
    <% end %>

    <% 
      date_work = @sheet.total_duration_for(date, :work)
      date_overtime = @sheet.total_overtime_for(date)
      if date_work != 0 || date_overtime != 0 
    %>
    <tr>
      <td colspan="5">
        Total Work: <%= format_duration(date_work, :work) %><br/>
        Total Overtime: <%= format_duration(date_overtime, :overtime)  %>
      </td>
    </tr>
    <%
      end
    %>
  </tbody>
<%
  end
%>
</table>
